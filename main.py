import os
import requests
import yfinance as yf  #

# GitHubのSecretsから読み込む設定
LINE_TOKEN = os.environ.get('LINE_TOKEN')
USER_ID = os.environ.get('USER_ID')

# --- 監視リストの設定 { "銘柄コード": 目標価格 } ---
# 日本株は「コード.T」、日経平均は「^N225」、米国株はそのまま（AAPL等）
watch_list = {
    "^N225": 40000,   # 日経平均が40000円以下なら
    "2112.T": 325,    # 塩水港精糖が325円以下なら
    "4689.T": 400,    # LINEヤフーが400円以下なら
    "5713.T": 3350,   # 住友金属鉱山が3350円以下なら
    "4326.T": 1500,   # インテージが1500円以下なら
    "9142.T": 3050,   # 九州旅客鉄道が3050円以下なら
    "8473.T": 2900,   # SBIHDが2900円以下なら
    "1963.T": 1450,   # 日揮HLDが1450円以下なら
    "4005.T": 360,    # 住友化学が360円以下なら
    "7956.T": 1375,   # ピジョンが1375円以下なら
    "3003.T": 1475,   # ヒューリックが1475円以下なら
    "8801.T": 1225,   # 三井不動産が1225円以下なら
    "8316.T": 3325,   # 三井住友FGが3325円以下なら
    "7272.T": 1025,   # ヤマハ発動機が1025円以下なら
    "7270.T": 2135,   # SUBARUが2135円以下なら
    "7202.T": 1525,   # いすゞ自動車が1525円以下なら
    "9513.T": 2225,   # 電源開発が2225円以下なら
    "2914.T": 3575,   # JTが3575円以下なら
    "9021.T": 2925,   # 西日本旅客鉄道が2925円以下なら
    "5110.T": 1500,   # 住友ゴムが1500円以下なら
    "8053.T": 3000,   # 住友商事が3000円以下なら
    "8002.T": 2500,   # 丸紅が2500円以下なら
    "5201.T": 4325,   # AGCが4325円以下なら
    "8031.T": 3025,   # 三井物産が3025円以下なら
    "5711.T": 2525,   # 三菱マテリアルが2525円以下なら
    "4452.T": 5030,   # 花王が5030円以下なら
    "8133.T": 1225,   # 伊藤忠エネクスが1225円以下なら
    "5108.T": 2530,   # ブリジストンが2530円以下なら
    "5105.T": 2230,   # TOYO TIREが2230円以下なら
    "4722.T": 1675,   # フューチャーが1675円以下なら
    "9432.T": 152,    # NTTが152円以下なら
    "9831.T": 440,    # ヤマダホールディングスが440円以下なら
    "3030.T": 720,    # ハブが720円以下なら
    "3224.T": 630,    # ゼネラル・オイスターが630円以下なら
    "2540.T": 1930,   # 養命酒酒造が1930円以下なら
    "2269.T": 3200,   # 明治ホールディングスが3200円以下なら
    "3099.T": 1900,   # 三越伊勢丹HDが1900円以下なら
    "9418.T": 1750,   # UNEXTが1750円以下なら
    "7203.T": 2500,   # トヨタが2500円以下なら
    "4967.T": 5100,   # 小林製薬が5100円以下なら
    "2590.T": 2500,   # ダイドーグループHDが2500円以下なら
    "9731.T": 2030,   # 白洋舎が2030円以下なら
    "4527.T": 2030,   # ロート製薬が2030円以下なら
    "7972.T": 2330,   # イトーキが2330円以下なら
    "9636.T": 1830,   # 西部ガスが1830円以下なら
    "2222.T": 1730,   # 寿スピリッツが1730円以下なら
    "8524.T": 400,    # 北洋銀行が400円以下なら
    "9735.T": 4030,   # セコムが4030円以下なら
    "7182.T": 1330,   # ゆうちょ銀行が1330円以下なら
    "2933.T": 800,    # 紀文食品が800円以下なら
    "2157.T": 800,    # コシダカが800円以下なら
    "7532.T": 800,    # パンパシIが800円以下なら
    "9023.T": 1350,   # 東京地下鉄が1350円以下なら
    "4540.T": 2930,   # ツムラが2930円以下なら
    "2915.T": 1550,   # ケンコーマヨネーズが1550円以下なら
    "7231.T": 2000,   # トピー工業が2000円以下なら
    "8281.T": 900,    # ゼビオが900円以下なら
    "9367.T": 900,    # 大東港運が900円以下なら
    "2590.T": 2500,   # Dydoが2475円以下なら
    "GOOGL": 300,     # アルファベット（米国株）が300ドル以下なら
    "JOBY": 12,       # ジョビー・アビエーション（米国株）が12ドル以下なら
}

def send_line(text):
    url = 'https://api.line.me/v2/bot/message/push'
    headers = {'Content-Type': 'application/json', 'Authorization': f'Bearer {LINE_TOKEN}'}
    data = {'to': USER_ID, 'messages': [{'type': 'text', 'text': text}]}
    requests.post(url, headers=headers, json=data)

# 結果を溜めておくためのリスト
alert_results = []

print("株価チェック開始...")

for ticker, threshold in watch_list.items():
    stock = yf.Ticker(ticker)
    # 直近の終値を取得
    hist = stock.history(period="1d")
    if hist.empty:
        continue
        
    current_price = hist['Close'].iloc[-1]
    
    print(f"チェック中: {ticker} (現在値: {current_price:.1f} / 目標: {threshold})")
    
    # 条件判定
    if current_price < threshold:
        alert_results.append(f"・{ticker}: {current_price:.1f}円 (目標:{threshold}円以下)")

# 1つでも条件に合致するものがあればLINE送信
if alert_results:
    message = "【株価アラート】\n目標価格に到達しました！\n\n" + "\n".join(alert_results)
    send_line(message)
    print("LINE送信完了")
else:
    # 条件に合致しなくても送るメッセージ
    message = "【定期報告】本日、条件を満たす銘柄はありませんでした。システムは正常に稼働しています。"
    send_line(message)
    print("定期報告LINEを送信しました")
